name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.2.0)"
        required: true
      notes:
        description: "Release notes"
        required: false

jobs:
  build:
    name: Build binaries
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            goos: linux
            ext: ""
          - os: windows-latest
            goos: windows
            ext: ".exe"

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential pkg-config \
            libglib2.0-dev libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build update-helper
        shell: bash
        run: |
          mkdir -p build/release

          if [ "${{ matrix.goos }}" = "windows" ]; then
            GOOS=windows GOARCH=amd64 \
              go build -o build/release/update-helper${{ matrix.ext }} ./cmd/update-helper
          else
            GOOS=linux GOARCH=amd64 \
              go build \
              -o build/release/update-helper ./cmd/update-helper
            chmod +x build/release/update-helper
          fi

      - name: Build HyLauncher
        run: |
          wails build -platform ${{ matrix.goos }}/amd64

      - name: Collect binaries
        shell: bash
        run: |
          if [ "${{ matrix.goos }}" = "windows" ]; then
            cp build/bin/HyLauncher.exe build/release/HyLauncher-windows-x64.exe
          else
            cp build/bin/HyLauncher build/release/HyLauncher-linux-x64
            chmod +x build/release/HyLauncher-linux-x64
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.goos }}
          path: build/release/*

  release:
    name: Create GitHub release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Ensure zip is installed
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            choco install zip -y
          else
            sudo apt update && sudo apt install -y zip
          fi

      - name: Prepare release directory
        run: |
          mkdir release
          cp artifacts/**/** release/
          ls -lh release/

      - name: Generate version.json
        run: |
          VERSION="${{ inputs.version }}"

          LINUX_LAUNCHER_SHA=$(sha256sum release/HyLauncher-linux-x64 | cut -d' ' -f1)
          LINUX_HELPER_SHA=$(sha256sum release/update-helper-linux | cut -d' ' -f1)

          WINDOWS_LAUNCHER_SHA=$(sha256sum release/HyLauncher-windows-x64.exe | cut -d' ' -f1)
          WINDOWS_HELPER_SHA=$(sha256sum release/update-helper-windows.exe | cut -d' ' -f1)

          cat <<EOF > release/version.json
          {
            "version": "$VERSION",
            "linux": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/HyLauncher-linux-x64",
                  "sha256": "$LINUX_LAUNCHER_SHA"
                },
                "helper": {
                  "url": "https://github.com/ArchDevs/HyLauncher/releases/latest/download/update-helper",
                  "sha256": "$LINUX_HELPER_SHA"
                }
              }
            },
            "windows": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/HyLauncher-windows-x64.exe",
                  "sha256": "$WINDOWS_LAUNCHER_SHA"
                },
                "helper": {
                  "url": "https://github.com/ArchDevs/HyLauncher/releases/latest/download/update-helper.exe",
                  "sha256": "$WINDOWS_HELPER_SHA"
                }
              }
            }
          }
          EOF

      - name: Package online-fix.zip
        run: |
          echo "Packaging online-fix.zip..."
          cd assets
          zip -r ../release/online-fix.zip Client Server
          cd ..
          ls -lh release/online-fix.zip

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          body: ${{ inputs.notes }}
          files: |
            release/*

  cleanup:
    name: Cleanup old artifacts
    needs: release
    if: success()
    runs-on: ubuntu-latest

    permissions:
      actions: write

    steps:
      - name: Delete artifacts from previous runs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Fetching artifactsâ€¦"

          ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/artifacts \
            --jq '.artifacts[] | select(.workflow_run.id != '${{ github.run_id }}') | .id')

          if [ -z "$ARTIFACTS" ]; then
            echo "No old artifacts found."
            exit 0
          fi

          for id in $ARTIFACTS; do
            echo "Deleting artifact ID: $id"
            gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$id
          done
